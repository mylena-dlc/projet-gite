name: CI/CD Workflow

on:
  push:
    branches:
      - develop
      - test
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
          MYSQL_USER: user
          MYSQL_PASSWORD: password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ†” DÃ©finir UID et GID
        run: |
          echo "UID=$(id -u)" >> $GITHUB_ENV
          echo "GID=$(id -g)" >> $GITHUB_ENV

      - name: ğŸ“Œ VÃ©rifier la structure du projet
        run: |
          echo "ğŸ“Œ Chemin actuel : $(pwd)"
          ls -lah

      - name: â³ Attendre que MySQL soit prÃªt
        run: sleep 15

      - name: ğŸš€ DÃ©marrer les services Docker
        run: |
          docker compose up -d
          sleep 10
          docker compose ps

      - name: â³ VÃ©rifier si le conteneur PHP est prÃªt
        run: |
          until docker compose exec -T php php -v &>/dev/null; do
            echo "â³ En attente du conteneur PHP..."
            sleep 5
          done
          echo "âœ… Conteneur PHP prÃªt !"

      - name: ğŸ” VÃ©rification des permissions
        run: |
          docker compose exec -T php bash -c "
            echo 'ğŸ” Utilisateur actuel :'
            whoami
            echo 'ğŸ” UID/GID actuel :'
            id
            echo 'ğŸ” Permissions sur /var/www :'
            ls -ld /var/www || echo 'âš ï¸ /var/www introuvable'
            echo 'ğŸ” Permissions sur /var/www/var :'
            ls -ld /var/www/var || echo 'âš ï¸ /var/www/var introuvable'
          "

      - name: ğŸ› ï¸ Correction des permissions et crÃ©ation des dossiers nÃ©cessaires
        run: |
          docker compose exec -T php bash -c "
            echo 'ğŸ”§ Correction des permissions sur /var/www'
            mkdir -p /var/www/var/cache /var/www/var/log
            chown -R www-data:www-data /var/www
            chmod -R 775 /var/www
          "

      - name: ğŸ“„ VÃ©rifier et crÃ©er le fichier .env si manquant
        run: |
          docker compose exec -T php bash -c "
            if [ ! -f '/var/www/.env' ]; then
              echo 'âŒ .env introuvable, crÃ©ation en cours...'
              echo 'APP_ENV=test' > /var/www/.env
              echo 'APP_SECRET=${{ secrets.APP_SECRET }}' >> /var/www/.env
              echo 'DATABASE_URL=mysql://user:password@127.0.0.1:3306/test_db?serverVersion=8.0' >> /var/www/.env
              echo 'MAILER_DSN=null://null' >> /var/www/.env
              echo 'âœ… .env crÃ©Ã© avec succÃ¨s.'
            else
              echo 'âœ… .env existe dÃ©jÃ .'
            fi
          "

      - name: ğŸ“¦ Installer les dÃ©pendances PHP
        run: |
          docker compose exec -T php composer install --no-interaction --prefer-dist

      - name: ğŸ› ï¸ VÃ©rifier l'existence du dossier vendor
        run: |
          docker compose exec -T php ls -ld /var/www/vendor
          if [ ! -d "/var/www/vendor" ]; then
            echo "âŒ ERREUR : Le dossier vendor/ est manquant aprÃ¨s composer install !"
            exit 1
          fi

      - name: ğŸ”‘ Donner les permissions au bin/console
        run: |
          docker compose exec -T php chmod +x /var/www/bin/console

      - name: ğŸš€ Nettoyer et recompiler le cache Symfony
        run: |
          docker compose exec -T php php bin/console cache:clear --no-warmup

      - name: ğŸ—„ï¸ CrÃ©er et mettre Ã  jour la base de donnÃ©es
        run: |
          docker compose exec -T php php bin/console doctrine:database:create --if-not-exists
          docker compose exec -T php php bin/console doctrine:migrations:migrate --no-interaction

      - name: ğŸ“¥ Installer Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Installer les dÃ©pendances NPM
        run: |
          docker compose exec -T php npm install

      - name: âš¡ Compiler les assets
        run: |
          docker compose exec -T php npm run build

      - name: ğŸ› ï¸ Debugger les routes Symfony
        run: |
          docker compose exec -T php php bin/console debug:router

      - name: âœ… Lancer les tests PHPUnit
        run: |
          docker compose exec -T php php bin/phpunit

  merge-to-test:
    needs: test
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ› ï¸ Fusion de develop dans test
        run: |
          git checkout test
          git pull origin test --allow-unrelated-histories || true
          git merge develop --no-ff -m "Fusion de develop dans test"
          git push origin test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  merge-to-main:
    needs: merge-to-test
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ› ï¸ Fusion de test dans main
        run: |
          git checkout main
          git pull origin main --allow-unrelated-histories || true
          git merge test --no-ff -m "Fusion de test dans main"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: merge-to-main
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ“¥ Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main

      - name: ğŸ–¥ï¸ Debug SSH connection
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            whoami
            hostname
            ls -lah /var/www/projet-gite

      - name: ğŸš€ DÃ©ploiement sur VPS
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/projet-gite
            git pull origin main
            sudo chown -R www-data:www-data /var/www
            sudo chmod -R 775 /var/www/var/cache /var/www/var/log
            sudo rm -rf /var/www/var/cache/prod
            php bin/console cache:clear --env=prod
            php bin/console cache:warmup --env=prod
            sudo systemctl restart apache2
