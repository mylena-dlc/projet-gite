{% extends 'base.html.twig' %}

{% block title %}Tableau de bord admin
{% endblock %}

{% block body %}

	{% include "_partials/_header.html.twig" %}

	<section class="p-6 mb-32 mt-6 lg:p-12">

        <div>
            <a href="javascript:history.back()" class="my-4 border px-2 mb-4 rounded-lg">
                <i class="fa-solid fa-chevron-left pr-2 text-sm"></i>Retour
            </a>
        </div>
        <h1 class="my-4">Statistiques</h1>
		<div class="space-y-4">
            <h3>Avis</h3>
            <div class="flex mx-4"> 
                <div class="w-1/2">
                    <p class="font-bold">{{ averageRating|number_format(2, ',') }} <i class="fa-solid fa-star"></i></p>
                    <p>Évaluations globale</p>
                </div>
                <div class="w-1/2">
                <p class="font-bold">{{ reviews|length }} <i class="fa-solid fa-comment"></i></p>
                    <p>Commentaires</p>
                </div>
            </div>

            <div class="line"></div>

            <div class="space-y-4">
                <h3>Réservations</h3>
                <div class="flex mx-4"> 
                    <div class="w-1/2">
                        <p class="font-bold">{{ allReservations|length }} <i class="fa-solid fa-mountain-sun"></i></p>
                        <p>Réservations confirmées</p>
                    </div>
                    <div class="w-1/2">
                        <p class="font-bold">{{ allReservationsCancel|length }} <i class="fa-solid fa-ban"></i></p>
                        <p>Réservations annulées</p>
                    </div>
                </div>
            </div>

            <div class="line"></div>

            <h3>Taux de remplissage</h3>
                <div id="myCarousel" class="f-carousel">
                    {% for data in monthlyData %}
                        <div class="f-carousel__slide" data-chart-id="chart{{ loop.index }}">
                            <h4>Taux d'occupation pour {{ data.month }} {{ data.year }}</h4>
                            <p class="font-bold">{{ data.occupancyRate }}%</p>
                            <div class="mx-10">
                                <canvas 
                                    id="chart{{ loop.index }}" 
                                    data-chart-initialized="false"
                                    data-reserved="{{ data.totalNightsReserved }}"
                                    data-available="{{ data.daysInMonth - data.totalNightsReserved }}">
                                </canvas>
                            </div>
                        </div>
                    {% endfor %}
                </div>
		</div>
	</section>
	{% include "_partials/_footer_admin.html.twig" %}
    {% block custom_javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/carousel/carousel.css" />
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/carousel/carousel.umd.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const carousel = new Carousel(document.getElementById("myCarousel"), {
            Dots: false,
            Navigation: false,
        });

        carousel.on("change", (carouselInstance, slide) => {
            if (!slide || !slide.el) return;

            const chartId = slide.el.dataset.chartId;
            const canvas = document.getElementById(chartId);

            if (canvas && canvas.dataset.chartInitialized === "false") {
                const ctx = canvas.getContext("2d");

                new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Nuits réservées", "Nuits disponibles"],
                        datasets: [{
                            data: [
                                parseInt(canvas.dataset.reserved),
                                parseInt(canvas.dataset.available)
                            ],
                            backgroundColor: ["#b58869", "#a9b4a4"],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });

                canvas.dataset.chartInitialized = "true";
            }
        });

        // On initialise manuellement le premier slide
        if (carousel.slides.length > 0) {
            carousel.emit("change", carousel, carousel.slides[0]);
        }
    });
</script>
{% endblock %}



    {# {% block custom_javascripts %}
   <script>
        document.addEventListener("DOMContentLoaded", () => {
            const carouselStats = document.querySelector("#myCarousel");

            if (carouselStats) {
                const instance = new Fancybox.Carousel(carouselStats, {
                    Dots: true,
                    Navigation: false,
                });

                instance.on("change", (carousel, slide) => {
                    const chartId = slide.el.dataset.chartId;
                    const canvas = document.getElementById(chartId);

                    if (canvas && canvas.dataset.chartInitialized === "false") {
                        const ctx = canvas.getContext("2d");

                        new Chart(ctx, {
                            type: "doughnut",
                            data: {
                                labels: ["Nuits réservées", "Nuits disponibles"],
                                datasets: [{
                                    data: [
                                        parseInt(canvas.dataset.reserved),
                                        parseInt(canvas.dataset.available)
                                    ],
                                    backgroundColor: ["#b58869", "#a9b4a4"],
                                    hoverOffset: 4
                                }]
                            },
                            options: { responsive: true }
                        });

                        canvas.dataset.chartInitialized = "true";
                    }
                });
                instance.emit("change", instance, instance.slides[0]);
            }
    });

</script>
    {% endblock %}  #}
{% endblock %}
